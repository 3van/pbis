#!/bin/bash

log_info()
{
    echo "$@" 1>&2
}

stop_and_disable_old_daemon()
{
    SERVICE=$1
    SERVICE_PATH=/opt/likewise/sbin/$SERVICE
    SERVICE_NAME=com.likewisesoftware.$SERVICE
    SERVICE_DAEMON_OLD=/System/Library/LaunchDaemons/$SERVICE_NAME.plist

    if [ -f $SERVICE_DAEMON_OLD ]; then
        launchctl list | grep $SERVICE_NAME > /dev/null
        if [ $? -eq 0 ]; then
            log_info "Stopping Likewise $SERVICE service"
            launchctl stop $SERVICE_NAME > /dev/null
        fi
        log_info "Disable Likewise $SERVICE service"
        launchctl unload $SERVICE_DAEMON_OLD > /dev/null
        rm $SERVICE_DAEMON > /dev/null
        if [ -f $SERVICE_PATH ]; then
            rm $SERVICE_PATH > /dev/null
        fi
    fi
}

stop_and_disable_daemon()
{
    SERVICE=$1
    SERVICE_PATH=/opt/likewise/sbin/$SERVICE
    SERVICE_NAME=com.likewisesoftware.$SERVICE
    SERVICE_DAEMON=/Library/LaunchDaemons/$SERVICE_NAME.plist

    if [ -f $SERVICE_DAEMON ]; then
        launchctl list | grep $SERVICE_NAME > /dev/null
        if [ $? -eq 0 ]; then
            log_info "Stopping Likewise $SERVICE service"
            launchctl stop $SERVICE_NAME > /dev/null
        fi
        log_info "Disable Likewise $SERVICE service"
        launchctl unload $SERVICE_DAEMON > /dev/null
        rm $SERVICE_DAEMON > /dev/null
        if [ -f $SERVICE_PATH ]; then
            rm $SERVICE_PATH > /dev/null
        fi
    fi
}

save_daemon()
{
    SERVICE=$1
    SERVICE_PATH=/opt/likewise/sbin/$(SERVICE)d
    SERVICE_NAME=com.likewisesoftware.$(SERVICE)d
    SERVICE_DAEMON=/Library/LaunchDaemons/$SERVICE_NAME.plist

    if [ -f $SERVICE_DAEMON ]; then
        launchctl list | grep $SERVICE_NAME > /dev/null
        if [ $? -eq 0 ]; then
            log_info "Saving running status of Likewise $SERVICE service"
            touch /tmp/$SERVICE.restart
        fi
    fi
}

stop_obsolete_daemons()
{
    stop_and_disable_old_daemon npcmuxd
    stop_and_disable_daemon npcmuxd
    stop_and_disable_daemon lwrdrd
    stop_and_disable_daemon lsmbd
    stop_and_disable_old_daemon dcerpcd
    stop_and_disable_daemon lwmgmtd
    stop_and_disable_old_daemon netlogond

    log_info "All obsolete Likewise services now stopped and disabled"
}

save_daemons()
{
    save_daemon lsass
    save_daemon netlogon
    save_daemon eventlog
    save_daemon lwio
    save_daemon dcerpc

    log_info "All Likewise services now have their running status saved"
}

disable_plugin()
{
    PLUGIN_DIR_OPEN=LWIDSPlugin.dsplug
    PLUGIN_DIR_ENT=LWEDSPlugin.dsplug
    PLUGIN_DIR=LWDSPlugin.dsplug
    SRC_DIR=/opt/likewise/lib
    FRAMEWORK_DIR="/System/Library/Frameworks/DirectoryService.framework/Resources/Plugins"
    LIBRARY_DS_DIR="/Library/DirectoryServices/PlugIns"

    log_info "Disable any former Likewise DS plugin links"
    if [ -h $FRAMEWORK_DIR/$PLUGIN_DIR_OPEN ]; then
       /bin/rm -f $FRAMEWORK_DIR/$PLUGIN_DIR_OPEN
    fi

    if [ -h $FRAMEWORK_DIR/$PLUGIN_DIR_ENT ]; then
       /bin/rm -f $FRAMEWORK_DIR/$PLUGIN_DIR_ENT
    fi

    log_info "Disable prior Likewise DS plugin link"
    if [ -h $FRAMEWORK_DIR/$PLUGIN_DIR ]; then
       /bin/rm -f $FRAMEWORK_DIR/$PLUGIN_DIR
    fi

    if [ -h $LIBRARY_DS_DIR/$PLUGIN_DIR ]; then
       /bin/rm -r $LIBRARY_DS_DIR/$PLUGIN_DIR
    fi
}

determine_upgrade_type()
{
    VERSIONFILE=/opt/likewise/data/VERSION
    if [ -f $VERSIONFILE ]; then
        log_info "Previous Likewise software installation detected"
        if [ -n "`grep '^VERSION=5.0' $VERSIONFILE`" -o \
             -n "`grep '^VERSION=5.1' $VERSIONFILE`" -o \
             -n "`grep '^VERSION=5.2' $VERSIONFILE`" -o \
             -n "`grep '^VERSION=5.3' $VERSIONFILE`" ]; then
            log_info "Upgrade install from 5.0-5.3 version"
            UPGRADING_FROM_5_0123=1
            UPGRADEDIR5=/tmp/lw-upgrade-5
            mkdir -p "${UPGRADEDIR5}"
            log_info "Preserving 5.0-5.3  configuration in ${UPGRADEDIR5}."
        else
            log_info "Upgrade install from 6.X version"
            UPGRADING_FROM_6_0=1
            UPGRADEDIR6=/tmp/lw-upgrade-6
            mkdir -p "${UPGRADEDIR6}"
            log_info "Preserving 6.0 configuration in ${UPGRADEDIR6}."
        fi
    else
        log_info "Regular install"
    fi
}

preserve_5_0123_configuration()
{
    if [ -n "${UPGRADING_FROM_5_0123}" ]; then
        if [ -f "/etc/likewise/eventlogd.conf" ]; then
            cp "/etc/likewise/eventlogd.conf" "${UPGRADEDIR5}"
        fi

        if [ -f "/etc/likewise/lsassd.conf" ]; then
            cp "/etc/likewise/lsassd.conf" "${UPGRADEDIR5}"
        fi

        if [ -f "/etc/likewise/netlogon.conf" ]; then
            cp "/etc/likewise/netlogon.conf" "${UPGRADEDIR5}"
        fi

        if [ -f "/var/lib/likewise/db/pstore.db" ]; then
            cp "/var/lib/likewise/db/pstore.db" "${UPGRADEDIR5}"
            chmod 700 "${UPGRADEDIR5}/pstore.db"
        fi
    fi
}

preserve_6_0_configuration()
{
    if [ -n "${UPGRADING_FROM_6_0}" ]; then
        if [ -f "/var/lib/likewise/db/registry.db" ]; then
            cp "/var/lib/likewise/db/registry.db" "${UPGRADEDIR6}"
            chmod 700 "${UPGRADEDIR6}/registry.db"
        fi

        if [ -f "/var/lib/likewise/db/sam.db" ]; then
            cp "/var/lib/likewise/db/sam.db" "${UPGRADEDIR6}"
            chmod 700 "${UPGRADEDIR6}/sam.db"
        fi

        if [ -f "/var/lib/likewise/db/lwi_events.db" ]; then
            cp "/var/lib/likewise/db/lwi_events.db" "${UPGRADEDIR6}"
            chmod 700 "${UPGRADEDIR6}/lwi_events.db"
        fi

        if [ -f "/var/lib/likewise/db/lsass-adcache.db" ]; then
            cp "/var/lib/likewise/db/lsass-adcache.db" "${UPGRADEDIR6}"
            chmod 700 "${UPGRADEDIR6}/lsass-adcache.db"
        fi
    fi
}


##
## Main
##

log_info "Determining if this is an upgrade for first time installation"
determine_upgrade_type

log_info "Stop and disable obsolete Likewise services"
stop_obsolete_daemons

# Save the daemon state
save_daemons

# Disable Likewise DS plugin
disable_plugin

# Save 5.[0123] configuration files and pstore.
preserve_5_0123_configuration

# Save 6.X configuration files and pstore.
preserve_6_0_configuration

# Remove previous Likwise installation with macuninstall.sh
/opt/likewise/bin/macuninstall.sh

log_info "Now going to extract all the Likewise components and install the binaries and configuration files"


