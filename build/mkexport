#!/bin/bash

source ${BUILD_ROOT}/src/linux/build/common.sh
source ${BUILD_ROOT}/src/linux/build/version.sh
source ${BUILD_ROOT}/src/linux/build/lib/dep-helper.sh

function usage
{
    echo "usage: `basename $0` <profileName>"
    echo ""
    echo "  profile names:"
    echo ""
    for profile in ${BUILD_ROOT}/src/linux/build/profiles/* ; do
        if [ -f "${profile}" ]; then
            echo "    `basename ${profile}`"
        fi
    done
    exit 1
}

while /bin/true; do
    case "$1" in
        --help)
            usage
            ;;
        -*)
            echo "Invalid option: $1"
            usage
            ;;
        *)
            break
            ;;
    esac
    shift
done

OPT_PROFILE="$1"
shift
if [ -z "${OPT_PROFILE}" ]; then
    echo "Missing profileName argument."
    usage
fi

if [ -n "$1" ]; then
    echo "Too many arguments."
    usage
fi

EXPORT_ROOT="${BUILD_ROOT}-${OPT_PROFILE}"
EXPORT_TARBALL="${EXPORT_ROOT}-${SVN_REVISION}.tar.bz2"

load_profile $OPT_PROFILE

products="${BUILD_PRODUCTS}"
packages="`product_packages $products`"
components="`product_components $products`"
build_list="`component_build_list $components`"
sources="`component_sources $build_list`"

ALWAYS_PROTECTED=" \
     ${BUILD_ROOT}/src/linux/bin \
     ${BUILD_ROOT}/src/linux/build \
     ${BUILD_ROOT}/src/linux/config \
     ${BUILD_ROOT}/src/linux/docs \
     ${BUILD_ROOT}/src/linux/examples \
     ${BUILD_ROOT}/src/linux/licenses \
     ${BUILD_ROOT}/src/linux/build/products/install.sh \
     ${BUILD_ROOT}/src/linux/build/products/LICENSES \
     ${BUILD_ROOT}/src/linux/build/packages/EXTRAS \
     ${BUILD_ROOT}/src/linux/build/profiles/default \ 
     ${BUILD_ROOT}/src/linux/REVISION \ 
     "

protected="$ALWAYS_PROTECTED $sources ${BUILD_ROOT}/src/linux/build/profiles/$OPT_PROFILE"

for pkg in $packages
do
    protected="$protected ${BUILD_ROOT}/src/linux/build/packages/$pkg"
done

for comp in $build_list
do
    protected="$protected ${BUILD_ROOT}/src/linux/build/components/$comp.comp"
done

for prod in $products
do
    protected="$protected ${BUILD_ROOT}/src/linux/build/products/$prod"
done

echo "Exporting to ${EXPORT_ROOT}"
rm -rf "${EXPORT_ROOT}"
svn export --force "${BUILD_ROOT}" "${EXPORT_ROOT}"

echo "Setting the default profile to $OPT_PROFILE"
rm -f "${EXPORT_ROOT}/src/linux/build/profiles/default"
ln -s "$OPT_PROFILE" "${EXPORT_ROOT}/src/linux/build/profiles/default"

echo "Recording the revision number"
echo "${SVN_REVISION}" > "${EXPORT_ROOT}/src/linux/REVISION"

for dir in \
    ${BUILD_ROOT}/src/linux/* \
    ${BUILD_ROOT}/src/linux/build/components/* \
    ${BUILD_ROOT}/src/linux/build/products/* \
    ${BUILD_ROOT}/src/linux/build/profiles/* \
    ${BUILD_ROOT}/src/linux/build/packages/* \
    ${BUILD_ROOT}/src/windows \
    ${BUILD_ROOT}/packages \
    ${BUILD_ROOT}/tools
do
    exdir=`echo $dir | sed "s:^${BUILD_ROOT}:${EXPORT_ROOT}:"`
    if ! _contains $dir $protected
    then
        echo Pruning $exdir
        rm -rf "$exdir"
    fi
done

echo "Creating tarball ${EXPORT_TARBALL}"
(
    cd "`dirname ${EXPORT_ROOT}`"
    tar cjfv "${EXPORT_TARBALL}" "`basename ${EXPORT_ROOT}`"
)

rm -rf "${EXPORT_ROOT}"
