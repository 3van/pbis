#!/bin/bash

set -e

ORIG_PWD="${PWD}"
CLEAN=""
BOOTSTRAP=""
JOBS="4"

get()
{
    eval "result=\$$1"
}

fail()
{
    echo "$*" >&2
    exit 1
}

show()
{
    echo "+ $*"
    if [ -z "$SHOW" ]
    then
        time -p "$@"
    fi
}

if type gmake >/dev/null 2>&1
then
    MAKE=gmake
else
    MAKE=make
fi

if type gtar >/dev/null 2>&1
then
    TAR=gtar
else
    TAR=tar
fi

check_params()
{
    for param
    do
        get "$param"
        [ -n "$result" ] || fail "$param not specified"
    done
}

usage()
{
    echo "usage: `basename $0` --source DIR --build DIR --dist DIR [OPTIONS]

    --source DIR    -- source tree
    --build DIR     -- build output directory
    --dist DIR      -- \"final\" build output directory

  where OPTIONS are:

    --show          -- only show commands
    --jobs N        -- pass -j N to make when building
    --revision REV  -- source control revision (package name friendly form)
    --id ID         -- build number
    --config FILE   -- configuration file for MakeKit
    --path PATH     -- prepend to PATH (DIR[:DIR2[:...]])
    --clean         -- clean the build output first
    --bootstrap     -- just do bootstrapping (do not build)
"
    exit 1
}

while [ "$#" -gt 0 ]
do
    case "$1" in
        --show) SHOW="1"; shift;;
        --jobs) JOBS="$2"; shift 2;;
        --source) SOURCE_DIR="$2"; shift 2;;
        --build) BUILD_DIR="$2"; shift 2;;
        --dist) DIST_DIR="$2"; shift 2;;
        --revision) REVISION="$2"; shift 2;;
        --id) ID="$2"; shift 2;;
        --config) CONFIG="$2"; shift 2;;
        --path) PATH="$2:$PATH"; shift 2;;
        --clean) CLEAN="1"; shift;;
        --bootstrap) BOOTSTRAP="1"; CLEAN="1"; shift;;
        --help) usage;;
        --) shift; break;;
        *) break;;
    esac
done

check_params SOURCE_DIR BUILD_DIR DIST_DIR

show export PATH="$PATH"

[ -n "$CONFIG" ] && CONFIG_PARAM="@$SOURCE_DIR/build/mk-config/$CONFIG"
[ -n "$REVISION" ] && REVISION_PARAM="--build-revision=$REVISION"
[ -n "$ID" ] && ID_PARAM="--build-id=$ID"

if [ -n "$CLEAN" -a -d "$BUILD_DIR" ]
then
    show rm -rf "$BUILD_DIR"
fi

show mkdir -p "${BUILD_DIR}"
show cd "$BUILD_DIR"

show "${SOURCE_DIR}/configure" ${CONFIG_PARAM} ${REVISION_PARAM} ${ID_PARAM}

if [ -n "$BOOTSTRAP" ]
then
    exit 0
fi

for target
do
    show ${MAKE} -j"$JOBS" "$target"
done

if [ -d "$DIST_DIR/package" ]
then
    show rm -rf "$DIST_DIR/package"
fi

show mkdir -p "$DIST_DIR"
show cp -f "config.log" "$DIST_DIR/config.log"
show cp -r "package" "$DIST_DIR/package"

show cd "stage"
show tar czfv "$DIST_DIR/stage-${ID}-${REVISION}.tar.gz" .
