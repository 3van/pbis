#!/bin/bash

LWSM_NAME=com.likewisesoftware.lwsmd
LWSM_DAEMON=/Library/LaunchDaemons/$LWSM_NAME.plist
LWSM_DAEMON_INSTALL=/etc/likewise/LaunchDaemons/$LWSM_NAME.plist

LWREG_NAME=com.likewisesoftware.lwregd
LWREG_DAEMON=/Library/LaunchDaemons/$LWREG_NAME.plist
LWREG_DAEMON_INSTALL=/etc/likewise/LaunchDaemons/$LWREG_NAME.plist

echo "Configure Likewise Service Manager daemon"
if [ -f $LWSM_DAEMON_INSTALL ]; then
   cp $LWSM_DAEMON_INSTALL $LWSM_DAEMON
   launchctl load $LWSM_DAEMON || exit 1
   launchctl start $LWSM_NAME || exit 1
   echo "lwsmd successfully configured"
fi

echo "Configure Likewise Registry daemon"
if [ -f $LWREG_DAEMON_INSTALL ]; then
   cp $LWREG_DAEMON_INSTALL $LWREG_DAEMON
   launchctl load $LWREG_DAEMON || exit 1
   launchctl start $LWREG_NAME || exit 1
   echo "lwregd successfully configured"
fi

echo "Pausing for daemons to initialize"
sleep 5

for i in /etc/likewise/*.reg
do
    echo "Upgrading Likewise Registry with contents of $i"
    /opt/likewise/bin/lwregshell upgrade "$i" || exit 1
done

killall -HUP lwsmd || exit 1
