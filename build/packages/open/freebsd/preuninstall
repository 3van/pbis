#!/bin/sh

LOG=/tmp/LikewiseOpen.log
TLOG=/tmp/LikewiseOpenTemp.txt

DOMAINJOIN=/opt/likewise/bin/domainjoin-cli

log()
{
    echo $1
    echo $1 >> $LOG
}

exec_log()
{
    $1 > $TLOG
    err=$?
    if [ $err -eq 0 ]; then
        echo $1 >> $LOG
    else
        log "Error: $1 returned $err"
        log `cat $TLOG`
    fi
    rm -f $TLOG > /dev/null 2> /dev/null
}

exec_log_exit()
{
    $1 > $TLOG
    err=$?
    if [ $err -eq 0 ]; then
        echo $1 >> $LOG
    else
        log "Error: $1 returned $err"
        log `cat $TLOG`
        rm -f $TLOG > /dev/null 2> /dev/null
        exit 1
    fi
    rm -f $TLOG > /dev/null 2> /dev/null
}

preuninstall()
{
    log "Package: Likewise Open pre-uninstall begins (`date`)"

    # Remove references elsewhere.
    if [ -x /opt/likewise/bin/domainjoin-cli ]
    then
        exec_log "$DOMAINJOIN configure --disable pam"

        exec_log "$DOMAINJOIN configure --disable nsswitch"

        exec_log "$DOMAINJOIN configure --disable ssh"

        exec_log "$DOMAINJOIN configure --long `hostname -f` \
                              --short `hostname -s` \
                              --disable krb5 > $TLOG 2>&1"
    else
        log "Warning: $DOMAINJOIN is missing or not executable"
    fi

    # Stop all daemons; none should be needed anymore.
    if [ -x /etc/rc.d/lwsmd ]
    then
        exec_log "/etc/rc.d/lwsmd stop"
    else
        log "Warning: /etc/rc.d/lwsmd is missing or not executable"
    fi

    log "Package: Likewise Open pre-uninstall finished"
}

preuninstall
