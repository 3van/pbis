#!/bin/sh

UPGRADEDIR=/opt/likewise-upgrade
# PKG_ARCH="__PKG_ARCH"

LOG=/var/log/likewise-open-install.log
TLOG=/tmp/LikewiseOpenTemp.txt

# Display to screen and log file with a blank line between entires.
log()
{
    echo $@
    echo
    echo $@ >> $LOG
    echo >> $LOG
}

# Display to screen and log file with no blank line.
_log()
{
    echo $@
    echo $@ >> $LOG
}

# Display to file.
logfile()
{
    echo $@ >> $LOG
    echo >> $LOG
}

# Execute command.
# If successful, note in log file.
# If not successful, note on screen and log file.
run()
{
    $@ > $TLOG 2>&1
    err=$?
    if [ $err -eq 0 ]; then
        echo "Success: $@" >> $LOG
        cat $TLOG >> $LOG
        echo >> $LOG
    else
        _log "Error: $@ returned $err"
        _log `cat $TLOG`
        _log
    fi
    rm -f $TLOG > /dev/null 2>&1
    return $err
}

# Execute command.
# Log only to file.
run_quiet()
{
    $@ > $TLOG 2>&1
    err=$?
    if [ $err -eq 0 ]; then
        echo "Success: $@" >> $LOG
    else
        echo "Error: $@ returned $err  (ignoring and continuing)" >> $LOG
    fi
    cat $TLOG >> $LOG
    echo >> $LOG
    rm -f $TLOG > /dev/null 2>&1
    return $err
}

# Execute command.
# If successful, note in log file.
# If not successful, note on screen and log file and then exit.
run_or_fail()
{
    $@ > $TLOG 2>&1
    err=$?
    if [ $err -eq 0 ]; then
        echo "Success: $@" >> $LOG
        cat $TLOG >> $LOG
        echo >> $LOG
    else
        _log "Error: $@ returned $err  (aborting this script)"
        _log `cat $TLOG`
        _log
        rm -f $TLOG > /dev/null 2>&1
        exit 1
    fi
    rm -f $TLOG > /dev/null 2>&1
    return $err
}

import_service_configuration()
{
    run_quiet "svccfg delete TEMP/network/$1"
    run_quiet "svcadm disable $1"
    run_quiet "svccfg delete $1"

    run_or_fail "svccfg import /etc/likewise/svcs-solaris/$1.xml"
}

enable_service_configurations_or_init_d_symlinks()
{
    if [ -x /usr/sbin/svcadm ]; then
        log "Importing service configurations"
        import_service_configuration lwsmd
        import_service_configuration likewise

        run "/usr/sbin/svcadm enable lwsmd"
        run "/usr/sbin/svcadm enable likewise"
    else
    # On older Solaris systems, in order for a deamon to start in
    # multi-user mode a start symlink must be put in /etc/rc2.d, and a stop
    # symlink must be put in /etc/rc0.d, /etc/rc1.d, /etc/rcS.d
        run "ln -s /etc/init.d/lwsmd /etc/rc0.d/K08lwsmd"
        run "ln -s /etc/init.d/lwsmd /etc/rc1.d/K08lwsmd"
        run "ln -s /etc/init.d/lwsmd /etc/rcS.d/K08lwsmd"
        run "ln -s /etc/init.d/lwsmd /etc/rc2.d/S17lwsmd"

        run "ln -s /etc/init.d/likewise /etc/rc0.d/K07likewise"
        run "ln -s /etc/init.d/likewise /etc/rc1.d/K07likewise"
        run "ln -s /etc/init.d/likewise /etc/rcS.d/K07likewise"
        run "ln -s /etc/init.d/likewise /etc/rc2.d/S18likewise"

        run "/etc/init.d/lwsmd start"
        run "/etc/init.d/likewise start"
    fi
}

import_registry_configurations()
{
    REGIMPORT='/opt/likewise/bin/lwregshell import'

    log "Importing registry..."
    run_or_fail "$REGIMPORT /opt/likewise/share/config/dcerpcd.reg"
    run_or_fail "$REGIMPORT /opt/likewise/share/config/eventlogd.reg"
    run_or_fail "$REGIMPORT /opt/likewise/share/config/lsassd.reg"
    run_or_fail "$REGIMPORT /opt/likewise/share/config/lwiod.reg"
    run_or_fail "$REGIMPORT /opt/likewise/share/config/lwreg.reg"
    run_or_fail "$REGIMPORT /opt/likewise/share/config/netlogond.reg"
}

determine_upgrade_type()
{
    PRESERVEDVERSIONFILE="${UPGRADEDIR}/VERSION"

    if [ -f $PRESERVEDVERSIONFILE ]; then
        run_or_fail "cat $PRESERVEDVERSIONFILE"
        if [ -n "`grep '^VERSION=5.0' $PRESERVEDVERSIONFILE`" ]; then
            UPGRADING_FROM_5_0123=1
            log "Upgrading from Likewise Identity Services Open 5.0"
        elif [ -n "`grep '^VERSION=5.1' $PRESERVEDVERSIONFILE`" ]; then
            UPGRADING_FROM_5_0123=1
            log "Upgrading from Likewise Identity Services Open 5.1."
        elif [ -n "`grep '^VERSION=5.2' $PRESERVEDVERSIONFILE`" ]; then
            UPGRADING_FROM_5_0123=1
            log "Upgrading from Likewise Identity Services Open 5.2."
        elif [ -n "`grep '^VERSION=5.3' $PRESERVEDVERSIONFILE`" ]; then
            UPGRADING_FROM_5_0123=1
            log "Upgrading from Likewise Identity Services Open 5.3."
        elif [ -n "`grep '^VERSION=6.0' $PRESERVEDVERSIONFILE`" ]; then
            UPGRADING_FROM_6_0=1
            log "Upgrading from Likewise Open 6.0."
        fi
    fi
}

import_5_0123_file()
{
    CONVERT="/opt/likewise/bin/conf2reg"
    REGIMPORT="/opt/likewise/bin/lwregshell import"

    COMMAND=$1
    SOURCE=$2
    # DEST is not necessary for some commands.
    DEST=$3

    if [ -f $SOURCE ]; then
        run_quiet "$CONVERT $COMMAND $SOURCE $DEST"
        if [ $? -ne 0 ]; then
            log "There was a problem converting $SOURCE. Please file a bug and attach $SOURCE."
            return 1
        fi

        if [ -n "$DEST" -a -f "$DEST" ]; then
            run_quiet "$REGIMPORT $DEST"
            if [ $? -ne 0 ]; then
                log "There was a problem converting $SOURCE. Please file a bug and attach $SOURCE and $DEST."
                return 1
            fi
        fi
    fi
    return 0
}

restore_5_0123_configuration()
{
    CONVERT="/opt/likewise/bin/conf2reg"

    if [ -z "$UPGRADING_FROM_5_0123" ]; then
        return 0
    fi

    import_5_0123_file "--lsass" "${UPGRADEDIR}/lsassd.conf" \
        "${UPGRADEDIR}/lsassd.conf.reg"

    import_5_0123_file "--netlogon" "${UPGRADEDIR}/netlogon.conf" \
        "${UPGRADEDIR}/netlogon.conf.reg"

    import_5_0123_file "--eventlog" "${UPGRADEDIR}/eventlogd.conf" \
        "${UPGRADEDIR}/eventlogd.conf.reg"

    import_5_0123_file "--pstore-sqlite" "${UPGRADEDIR}/pstore.db"
}

relocate_domain_separator()
{
    DomainSeparator=`/opt/likewise/bin/lwregshell list_values '[HKEY_THIS_MACHINE\Services\lsass\Parameters\Providers\ActiveDirectory]' | grep DomainSeparator | sed -e 's/ *[^ ]\+[ ]\+[^ ]\+[ ]\+"\([^ ]*\)"$/\1/'`

    if [ -n "${DomainSeparator}" ]; then
        if [ "$DomainSeparator" = "\\\\" ]; then
            DomainSeparator="\\"
        fi

        run_quiet /opt/likewise/bin/lwregshell set_value '[HKEY_THIS_MACHINE\Services\lsass\Parameters]' 'DomainSeparator' "$DomainSeparator"
    fi
}

relocate_space_replacement()
{
    SpaceReplacement=`/opt/likewise/bin/lwregshell list_values '[HKEY_THIS_MACHINE\Services\lsass\Parameters\Providers\ActiveDirectory]' | grep SpaceReplacement | sed -e 's/ *[^ ]\+[ ]\+[^ ]\+[ ]\+"\([^ ]*\)"$/\1/'`

    if [ -n "${SpaceReplacement}" ]; then
        run_quiet /opt/likewise/bin/lwregshell set_value '[HKEY_THIS_MACHINE\Services\lsass\Parameters]' 'SpaceReplacement' "$SpaceReplacement"
    fi
}

fix_60_registry()
{
    REGCLEANUP="/opt/likewise/bin/lwregshell cleanup"

    if [ -z "$UPGRADING_FROM_6_0" ]; then
        return 0
    fi

    # Migrate pstore entries from default to joined domain
    run "/opt/likewise/bin/regupgr61.sh --install"

    # Migrate some other entries
    relocate_domain_separator
    relocate_space_replacement

    run_or_fail "${REGCLEANUP} /opt/likewise/share/config/dcerpcd.reg"
    run_or_fail "${REGCLEANUP} /opt/likewise/share/config/eventlogd.reg"
    run_or_fail "${REGCLEANUP} /opt/likewise/share/config/lsassd.reg"
    run_or_fail "${REGCLEANUP} /opt/likewise/share/config/lwiod.reg"
    run_or_fail "${REGCLEANUP} /opt/likewise/share/config/lwreg.reg"
    run_or_fail "${REGCLEANUP} /opt/likewise/share/config/netlogond.reg"
}

switch_to_open_provider()
{
    _value='[HKEY_THIS_MACHINE\Services\lsass\Parameters\Providers\ActiveDirectory]'
    _path='/opt/likewise/lib/liblsass_auth_provider_ad_open.so'

    run_quiet "/opt/likewise/bin/lwregshell set_value $_value Path $_path"
}

postinstall()
{
    log "Package: Likewise Open postinstall begins (`date`)"
    log "Logging all operations to $LOG"

    run_or_fail "/opt/likewise/sbin/lwsmd --start-as-daemon --loglevel debug"

    determine_upgrade_type

    restore_5_0123_configuration

    import_registry_configurations

    fix_60_registry

    switch_to_open_provider

    run_or_fail "/opt/likewise/bin/lwsm shutdown"

    enable_service_configurations_or_init_d_symlinks

    run "/opt/likewise/bin/domainjoin-cli configure --enable pam"
    run "/opt/likewise/bin/domainjoin-cli configure --enable nsswitch"

    run_quiet "rm -rf ${UPGRADEDIR}"

    log "Package: Likewise Open postinstall finished"
    exit 0
}

postinstall

