#!/bin/sh

DAEMONS_TO_HALT=__LW_DAEMONS_TO_HALT

LOG=/tmp/LikewiseOpen.log
TLOG=/tmp/LikewiseOpenTemp.txt

log()
{
    echo $1
    echo $1 >> $LOG
}

exec_log()
{
    $1 > $TLOG
    err=$?
    if [ $err -eq 0 ]; then
        echo $1 >> $LOG
    else
        log "Error: $1 returned $err"
        log `cat $TLOG`
    fi
    rm -f $TLOG > /dev/null 2> /dev/null
}

exec_log_exit()
{
    $1 > $TLOG
    err=$?
    if [ $err -eq 0 ]; then
        echo $1 >> $LOG
    else
        log "Error: $1 returned $err"
        log `cat $TLOG`
        rm -f $TLOG > /dev/null 2> /dev/null
        exit 1
    fi
    rm -f $TLOG > /dev/null 2> /dev/null
}

determine_upgrade_type()
{
    VERSIONFILE=/opt/likewise/data/VERSION
    if [ -f $VERSIONFILE ]; then
        UPGRADING=1
        UPGRADEDIR=/opt/likewise-upgrade
        mkdir -p "${UPGRADEDIR}"

        if [ -n "`grep '^VERSION=5.0' $VERSIONFILE`" -o \
             -n "`grep '^VERSION=5.1' $VERSIONFILE`" -o \
             -n "`grep '^VERSION=5.2' $VERSIONFILE`" -o \
             -n "`grep '^VERSION=5.3' $VERSIONFILE`" ]; then
            UPGRADING_FROM_5_0123=1
            log "Preserving 5.x (0 <= x <= 3) configuration in ${UPGRADEDIR}."
        elif [ -n "`grep '^VERSION=5.4' $VERSIONFILE`" ]; then
            UPGRADING_FROM_5_4=1
            log "Preserving 5.4 configuration in ${UPGRADEDIR}."
        fi
    fi
}

preserve_5_0123_configuration()
{
    if [ -n "${UPGRADING_FROM_5_0123}" ]; then
        if [ -f "/etc/likewise/eventlogd.conf" ]; then
            cp "/etc/likewise/eventlogd.conf" "${UPGRADEDIR}"
        fi

        if [ -f "/etc/likewise/lsassd.conf" ]; then
            cp "/etc/likewise/lsassd.conf" "${UPGRADEDIR}"
        fi

        if [ -f "/etc/likewise/netlogon.conf" ]; then
            cp "/etc/likewise/netlogon.conf" "${UPGRADEDIR}"
        fi

        if [ -f "/var/lib/likewise/db/pstore.db" ]; then
            cp "/var/lib/likewise/db/pstore.db" "${UPGRADEDIR}"
            chmod 700 "${UPGRADEDIR}/pstore.db"
        fi
    fi
}

preserve_5_4_configuration()
{
    if [ -n "${UPGRADING_FROM_5_4}" ]; then
        for file in dcerpcd.reg eventlogd.reg lsassd.reg lwiod.reg lwreg.reg netlogond.reg pstore.reg
        do
            if [ -f "/etc/likewise/${file}" ]; then
                cp "/etc/likewise/${file}" "${UPGRADEDIR}"
            fi
        done
    fi
}

postinstall()
{
    log "Package: Likewise Open Upgrade Helper begins (`date`)"

    # Stop any Likewise daemon (process capture for debugging).
    exec_log "ps -ef"
    for $daemon in $DAEMONS_TO_HALT
    do
        if [ -x /etc/rc.d/$daemon]; then
            exec_log "svcadm disable $daemon"
            exec_log "/etc/rc.d/$daemon stop"
            exec_log "killall -KILL $daemon"
        fi
    done

    determine_upgrade_type

    preserve_5_0123_configuration

    preserve_5_4_configuration

    log "Package: Likewise Open Upgrade Helper finished"
}

postinstall
