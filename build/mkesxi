#!/bin/bash

ARG_TGZ="$1"
ARG_TOOLS_TGZ="$2"

if [ -z "${ARG_TGZ}" -o -z "${ARG_TOOLS_TGZ}" -o -n "$3" ]; then
    echo "usage: `basename $0` TGZ-FILENAME TOOLS-TGZ-FILENAME"
    echo ""
    echo "  Creates TGZ-FILENAME and TOOLS-TGZ-FILENAME from"
    echo "  built components."
    echo ""
    exit 1
fi

case "${ARG_TGZ}" in
    /*)
        TGZ="${ARG_TGZ}"
        ;;
    *)
        TGZ="`pwd`/${ARG_TGZ}"
        ;;
esac

case "${ARG_TOOLS_TGZ}" in
    /*)
        TOOLS_TGZ="${ARG_TOOLS_TGZ}"
        ;;
    *)
        TOOLS_TGZ="`pwd`/${ARG_TOOLS_TGZ}"
        ;;
esac

if [ -z "${BUILD_ROOT}" ]; then
    echo "You need to source buildenv first" 1>&2
    exit 1
fi

TEMP_DIR="${BUILD_META_OS_ROOT}/esxi"
TOOLS_TEMP_DIR="${BUILD_META_OS_ROOT}/esxi-tools"

echo "Setting up contents in ${TEMP_DIR} and ${TOOLS_TEMP_DIR}"

rm -rf "${TEMP_DIR}" "${TOOLS_TEMP_DIR}" || exit 1
mkdir ${TOOLS_TEMP_DIR} ${TOOLS_TEMP_DIR}/bin ${TOOLS_TEMP_DIR}/lib

mkinstall lwesxi "${TEMP_DIR}" || exit 1
cd "${TEMP_DIR}" || exit 1

mkdir ${TEMP_DIR}/etc/likewise/db

rm data/VERSION
rm -fr data

# Remove devel stuff
rm lib/*.la
rm lib/*.a
rm lib/security/*.la
rm -rf include

# Don't need these
rm -rf share # Contains IDL compiler translation catalogue
rm -rf usr                # Contains a domainjoin-cli symlink
rm -rf etc/likewise/eventlog
rm -rf etc/likewise/lib
rm -rf etc/likewise/rpc

rm etc/init.d/dcerpcd
rm etc/init.d/eventlogd
rm etc/likewise/eventlogd.conf
rm etc/likewise/pstore.conf
rm etc/likewise/lwiod.conf

rm sbin/dcerpcd
rm -rf bin/demo
rm bin/iconv
rm bin/idl
rm bin/dceidl
rm bin/test*
rm bin/gpcron
rm bin/ConfigureLogin
rm sbin/eventlogd
rm lib/libeventlog*
rm -rf lib/pkgconfig
rm lib/lwicompat*
rm lib/libwbclient*
rm lib/liblsaaccess.so

rm lib/libfuse.so*
rm lib/libgssntlm.so*
rm lib/libgssrpc.so*
rm lib/libiconv.so*
rm lib/libldap-*.so*
rm lib/liblwioshareinfo.so*
rm lib/liblwrpcrt.so*
rm lib/libsamdb.so
rm lib/libsqlite3.so*
rm lib/libulockmgr.so*
rm lib/libuuid.so*
rm lib/libschannel.so*

rm bin/krb5-config
rm bin/ksu
rm bin/kvno
rm bin/lw-add-group
rm bin/lw-add-user
rm bin/lw-addevent
rm bin/lw-del-group
rm bin/lw-del-user
rm bin/lw-eventlog-cli
rm bin/lw-mod-user
rm bin/lwio-copy
rm bin/lwio-fuse-mount
rm bin/lwmapsecurity-test
rm bin/lwnet
rm bin/sqlite3

rm -f lib/libcrypto.so.0.9.8

find bin -type l |xargs rm
find lib -type l |xargs rm

liblist=`find lib -name "*.so.[0-9]*.*"`
for lib in $liblist; do
    newlib=`echo $lib|sed -e 's/\(.*so.[0-9]*\).*/\1/'`
    mv $lib $newlib
done

rm bin/init-base.sh

initlist=`find etc/init.d -type f`
for file in $initlist; do
    sed -e 's|.*init-base.sh||' $file >$file.new
    cat ${BUILD_ROOT}/src/linux/config/init-base.sh.esxi >>$file.new
    chmod 755 etc/init.d/*.new
    mv $file.new $file
done

mv etc/likewise/likewise-krb5-ad.conf etc/krb5.conf
touch etc/likewise/krb5-affinity.conf
echo -e "\0005\0002\c" >etc/krb5.keytab
echo -e "\0001\0000\0000\0000\c" >etc/likewise/db/pstore.filedb
echo -e "LFLT\0001\0000\0000\0000\c" >etc/likewise/db/netlogon-cache.filedb
echo -e "LFLT\0001\0000\0000\0000\c" >etc/likewise/db/lsass-adstate.filedb
echo -e "LWMA\0001\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\0000\c" >etc/likewise/db/lsass-adcache.filedb
chmod 1644 etc/krb5.conf etc/likewise/krb5-affinity.conf
chmod 1700 etc/krb5.keytab etc/likewise/db/* etc/likewise/*.conf

mv lib/libdes425.so* ${TOOLS_TEMP_DIR}/lib
mv lib/liblwdns.so* ${TOOLS_TEMP_DIR}/lib
mv bin/domainjoin-cli ${TOOLS_TEMP_DIR}/bin
mv bin/kdestroy ${TOOLS_TEMP_DIR}/bin
mv bin/kinit ${TOOLS_TEMP_DIR}/bin
mv bin/klist ${TOOLS_TEMP_DIR}/bin
mv bin/kpasswd ${TOOLS_TEMP_DIR}/bin
mv bin/ktutil ${TOOLS_TEMP_DIR}/bin
mv bin/lw* ${TOOLS_TEMP_DIR}/bin
mv ${TOOLS_TEMP_DIR}/bin/lw-lsa bin
mv bin/uuid ${TOOLS_TEMP_DIR}/bin
rmdir bin

strip -R .comment lib/*.so.* sbin/* lib/security/*.so  ${TOOLS_TEMP_DIR}/bin/* ${TOOLS_TEMP_DIR}/lib/*.so.*

cp ${BUILD_ROOT}/src/linux/config/lsassd.conf.esxi etc/likewise/lsassd.conf

tar cvzf "${TGZ}" * || exit 1
echo "Created tarball at ${ARG_TGZ}"

cd ${TOOLS_TEMP_DIR}
tar cvzf "${TOOLS_TGZ}" * || exit 1
echo "Created tarball at ${ARG_TOOLS_TGZ}"

exit 0
