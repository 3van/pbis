<?xml version="1.0"?>
<project>
  <target name="local.build">

    <property name="local.output" value="clientlib" />
    <if test="${build.vsarch!='x86'}">
      <fail message="${local.output} only builds for the x86 architecture!" />
    </if>

    <if test="${build.vsarch=='x86'}">
      <choose>
        <when test="${build.debug.boolean}">
          <property name="build.cflags" value="/Od /GL /FD /EHsc /Wp64 /Zi /MD /W3" />
          <property name="build.lflags" value="/DEBUG /MACHINE:X86" />
        </when>
        <otherwise>
          <property name="build.cflags" value="/O2 /FD /EHsc /Wp64 /Zi /MD /W3" />
          <property name="build.lflags" value="/DEBUG /MACHINE:X86" />
        </otherwise>
      </choose>
    </if>

    <cl outputdir="${build.meta.current}/">
      <includedirs>
        <include name="..\..\libunistr\include"/>
        <include name="..\..\lwbase\include"/>
        <include name="..\..\lwbase\include\win32"/>
        <include name="..\include"/>
        <include name="..\common"/>
	<include name="${build.meta.current}\..\idl"/>
      </includedirs>
      <sources>
        <include name="*.c"/>
	<include name="${build.meta.current}\..\idl\eventlog_c.c"/>
      </sources>
      <defines>
        <define name="LWEVENTLIB_EXPORTS"/>
        <define name="UNICODE"/>
        <define name="_UNICODE"/>
        <define name="WIN32"/>
        <define name="_WINDOWS"/>
        <define name="NDEBUG"/>
        <define name="_USRDLL"/>
        <define name="_WINDLL"/>
      </defines>
	<arg line="${build.cflags}" />
    </cl>
    <link output="${build.meta.current}/${local.output}.dll" options="/dll rpcrt4.lib advapi32.lib">
      <sources basedir="${build.meta.current}/">
        <include name="*.obj"/>
	<include name="${build.meta.current}\..\common\common.lib"/>
	<include name="${build.meta.current}\..\logging\logging.lib"/>
	<include name="${build.meta.current}\..\..\lwbase\lwbase.lib"/>
	<include name="${build.meta.current}\..\..\libunistr\libunistr.lib"/>
      </sources>
      <arg line="${build.lflags}" />
      <arg value="/PDB:${build.meta.current}/${local.output}.pdb" />
    </link>
    <exec program="mt.exe">
        <arg line='-manifest clientlib.dll.manifest -outputresource:"${build.meta.current}/${local.output}.dll;2"' />
    </exec>
    <copy todir="${build.dist.os}">
      <fileset basedir="${build.meta.current}">
	<include name="*.dll"/>
	<include name="*.exe"/>
	<include name="*.pdb"/>
      </fileset>
    </copy>
  </target>
</project>
